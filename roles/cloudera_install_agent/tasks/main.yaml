---
- name: update hosts file 
  ansible.builtin.copy:
    src: hosts
    dest: /etc/hosts
    mode: '0644'

- name: Disable swap for current session
  command: swapoff -a
  become: true
  changed_when: False 

- name: Disable swap permanently, persist reboots
  replace:
    path: /etc/fstab
    regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
    replace: '#\1\2\3swap\4'
    backup: yes

- name: Install Kerberos
  ansible.builtin.yum:
    name: 
      - krb5-workstation
      - krb5-libs
    state: present
- name: Setup Kerberos
  ansible.builtin.copy:
    src: krb5.conf
    dest: /etc/krb5.conf
    mode: '0644'
- name: Setup CDP Repository 
  ansible.builtin.yum_repository:
    name: cloudera-cdp
    description: Cloudera Data Platform YUM Repository 
    baseurl: "{{ cdp_repo_url }}"
    enabled: yes 
    gpgcheck: no 
- name: Install CDP agent
  ansible.builtin.yum:
    name: cloudera-manager-agent
    state: present
- name: configure agent 
  ansible.builtin.lineinfile:
    path: /etc/cloudera-scm-agent/config.ini
    line: "server_host={{ cdp_host }}"
    regexp: '^server_host=localhost.*$'
    backrefs: yes 
- name: create log cleaning cronjob 
  ansible.builtin.cron:
    name: "Hadoop Services log cleaning"
    minute: "30"
    job: "find /var/log ! -user root -mtime +3 -type f | /usr/bin/xargs rm -f"
# - name: start agent
#   ansible.builtin.systemd:
#     name: cloudera-scm-agent
#     state: started
#     enabled: yes 
